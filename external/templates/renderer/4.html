{% extends 'renderer/base.html' %}
{% load main_filters %}

{% block css %}
{{ block.super }}
<style>
    #main {
        display: grid;
        grid-template-columns: repeat(8, 100px);
        grid-template-rows: repeat(4, 100px);
        background-color: #ddd;
        width: 800px;
        height: 400px;
        margin: auto;
    }

    #ending {
        width: 800px;
        height: 400px;
        background-color: rgba(255, 255, 255, 0.5);
        opacity: 0;
        margin: auto;
        position: absolute;
        z-index: 1000;
        transition: 0.5s all;
        display: flex;
        align-items: center;
        font-size: 20px;
    }

    .node {
        width: 80px;
        height: 80px;
        margin: 10px;
        font-size: 28px;
        text-align: center;
        display: flex;
        align-items: center;
        border-radius: 5px;
        transition: 0.1s all;
    }

    .free {
        opacity: 60%;
    }

    .occupied {
        box-shadow: gray 0px 5px 10px;
    }

    div p {
        margin: auto;
        text-align: center;
    }
</style>
{% endblock %}

{% block descriptions %}
<div class='row x_block'>
    <div class='col-sm-2' id='d_turn'>回合</div>
    <div class='col-sm-4' id='d_action'>动作</div>
</div>
{% endblock %}

{% block display_body %}
<div class='col-sm-12'>
    <div id="main">
        <div id='ending'></div>
    </div>
</div>
{% endblock %}

{% block script %}
{{ block.super }}
<script>
    // 变量配置
    function init() {
        TOTAL_FRAMES = record_obj.logs.length
        PLAYING_FPS = 2
        // 创建棋盘
        var main = document.getElementById('main')
        for (var c = 0; c < 8; c++) {
            for (var r = 0; r < 4; r++) {
                var node = document.createElement('div')
                Object.assign(node, {
                    id: `tile${c}${r}`,
                    className: 'node',
                    style: `grid-column: ${c + 1};grid-row: ${r + 1};`
                })
                main.appendChild(node)
            }
        }
    }
    DIRECTIONS = {
        up: '上',
        down: '下',
        left: '左',
        right: '右',
    }
    COLORS = [
        'rgb(239,228,218)',
        'rgb(242,177,120)',
    ]

    // 更新描述
    var descrips = [
        document.getElementById('d_turn'),
        document.getElementById('d_action'),
    ]
    function update_descrip(op) {
        if (!op) { // 无操作
            for (var d of descrips) d.innerHTML = ''
            return
        }
        descrips[0].innerHTML = `第${op.r}回合`

        // 玩家动作
        var tmp = `${'先后'[op.p]}手玩家`
        if (op.d[0] == "direction") {
            var move = op.d[1]
            if (move in DIRECTIONS) tmp += `向${DIRECTIONS[move]}移动`
            else if (move == 'None') tmp += "放弃治疗"
            else tmp += `向"${DIRECTIONS[move]}"移动?`
        }
        else tmp += `落子于${op.d[1]}`

        descrips[1].innerHTML = tmp
    }

    // 更新棋盘
    function pick_data(index) { // 从指定帧向前查找直到获得棋盘
        for (; index >= 0; index--) {
            var tmp = record_obj.logs[index].P
            if (tmp) return tmp

        }
        return [[], [], [], []]
    }
    function update_board(data) { // 显示指定棋盘内容
        for (var r = 0; r < 4; r++) {
            for (var c = 0; c < 8; c++) {
                var cell = document.getElementById(`tile${c}${r}`),
                    num = data[r][c] || 0
                var is_occupied = (num != 0),
                    is_plr0 = is_occupied ? (num > 0) : (c < 4)

                // 更新样式
                if (is_occupied) {
                    cell.classList.add('occupied')
                    cell.classList.remove('free')
                    cell.innerHTML = `<p>${1 << Math.abs(num)}</p>`
                } else {
                    cell.classList.add('free')
                    cell.classList.remove('occupied')
                    cell.innerHTML = ''
                }

                // 更新颜色
                cell.style.backgroundColor = COLORS[1 - is_plr0]
            }
        }
    }

    // 更新结果显示
    var ending_mask = document.getElementById('ending')
    function update_ending(events) {
        if (!events) {
            ending_mask.style.opacity = 0
            return
        }
        ending_mask.style.opacity = 1
        ending_mask.innerHTML = ''
        var tmp = document.createElement('p')
        events.forEach((x, i) => {
            if (i) tmp.appendChild(document.createElement('br'))
            tmp.appendChild(new Text(x))
        })
        ending_mask.appendChild(tmp)
    }

    // 绘制接口
    function draw_frame(index = CURR_FRAME) {
        frame = record_obj.logs[index]
        if (!frame) return
        update_descrip(frame.D)
        update_board(pick_data(index))
        update_ending(frame.E)
    }
</script>
{% endblock %}